<header>
  <img alt="poof logo (poof magazine cover)" src="../common/poof.png" />
  <h1><em>poof!</em></h1>
  <p>Simple Secret Sharing</p>
</header>

<main>
  <ul>
    <li>Key: <input type="text" disabled id="key" /></li>
    <li>Passphrase: <input type="text" disabled id="passphrase" /></li>
    <li><button id="recv">Reveal Secret</button></li>
  </ul>
  <pre
    id="secret"
    style="
      background-color: #900;
      color: white;
      padding: 1em;
      margin: 1em;
      font-size: larger;
    "
  ></pre>
</main>
<footer>
  <p>
    <small>
      <a href="https://github.com/thechriswalker/poof">Source on Github</a>
    </small>
  </p>
</footer>
<script nomodule>
  alert("Sorry, your browser doesn't support the required features");
</script>
<script type="module">
  import {
    uint8ToBase64,
    base64ToUint8,
    supportsEnoughCrypto,
  } from "/common/util.js";
  main();
  async function main() {
    if (!(await supportsEnoughCrypto())) {
      alert("Sorry, your browser doesn't support the required features");
      return;
    }
    const $key = document.getElementById("key");
    const $passphrase = document.getElementById("passphrase");
    const $secret = document.getElementById("secret");
    const $button = document.getElementById("recv");

    // key and passphrase are in the fragment.
    const data = new URLSearchParams(location.hash.replace(/^#?/, ""));
    const key = data.get("key");
    if (key) {
      $key.value = key;
    }
    // passphrase should be in fragment.
    const phrase = data.get("pass");
    if (phrase) {
      $passphrase.value = phrase;
    }

    if (!key || !phrase) {
      alert(
        "URL does not contain all the required information. Please check the copied URL is complete and reload."
      );
      return;
    }

    const { subtle } = crypto;

    $button.addEventListener("click", async () => {
      const url = new URL("/api/recv", location);

      // hash the passphrase.
      const pass = new TextEncoder().encode($passphrase.value);
      const hash = uint8ToBase64(
        new Uint8Array(await subtle.digest("SHA-256", pass))
      );
      const payload = { key: $key.value, hash };
      console.log(payload);
      const { enc = null, errors = null } = await fetch(url.href, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(payload).toString(),
      }).then((r) => r.json());

      if (errors.length) {
        $secret.textContent = "Errors:\n - " + errors.join("\n - ");
        return;
      }

      // create a key from the passphrase.
      const passphraseKey = await subtle.importKey(
        "raw",
        pass,
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );
      const [b64salt, b64iv, b64ct] = enc.split(":");

      const salt = base64ToUint8(b64salt);
      const iv = base64ToUint8(b64iv);
      const ct = base64ToUint8(b64ct);
      const decKey = await subtle.deriveKey(
        {
          name: "PBKDF2",
          salt,
          iterations: 100000,
          hash: "SHA-256",
        },
        passphraseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["decrypt"]
      );

      const pt = await subtle.decrypt({ name: "AES-GCM", iv }, decKey, ct);
      const msg = new TextDecoder().decode(pt);

      // OK boom!
      $secret.textContent = msg;
    });
  }
</script>
